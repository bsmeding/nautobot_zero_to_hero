# Bootstrap configuration for mgmt (Alpine Linux)
# Management server configuration

# Configure management interface (eth0)
cat > /etc/network/interfaces << EOF
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 172.20.20.16
    netmask 255.255.255.0
    gateway 172.20.20.1

auto eth1
iface eth1 inet static
    address 10.0.0.16
    netmask 255.255.255.0
EOF

# Configure data interface (eth1)
# eth1 will be used for management server connections

# Set root password
echo "root:admin" | chpasswd

# Enable SSH with root login and password authentication
apk add --no-cache openssh
ssh-keygen -A
sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config
rc-update add sshd default

# Install network management tools
apk add --no-cache curl wget net-tools tcpdump nmap iperf3

# Install Python and pip for automation (commented out for faster startup)
# apk add python3 py3-pip
# pip3 install requests paramiko napalm

# Create management directory structure
mkdir -p /opt/management/{scripts,configs,logs}

# Add lab devices to /etc/hosts for easy access
cat >> /etc/hosts << HOSTS_EOF
# Lab devices
172.20.20.11    access1.lab access1
172.20.20.12    access2.lab access2
172.20.20.13    dist1.lab dist1
172.20.20.14    rtr1.lab rtr1
172.20.20.15    workstation1.lab workstation1
172.20.20.16    mgmt.lab mgmt management
HOSTS_EOF

# Set up basic logging
echo "Management server initialized at $(date)" > /var/log/management.log

# Enable network interfaces
ifup eth0
ifup eth1

echo "Management server bootstrap completed"

# Start SSH daemon in background (without -D flag)
/usr/sbin/sshd

# Script completes here, allowing containerlab deployment to finish
echo "Bootstrap script finished"
